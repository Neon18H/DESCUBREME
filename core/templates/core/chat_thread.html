{% extends 'base.html' %}
{% block content %}
<div class="container py-3">
  <a href="{% url 'chat_list' %}" class="btn btn-sm btn-outline-light mb-3">‚Üê Chats</a>
  <h4>Chat con @{{ other.username }}</h4>
  <div id="chat-box" class="border rounded p-3 bg-dark text-light" style="height:60vh;overflow-y:auto;">
    {% for m in messages_list %}
      <div class="mb-2 {% if m.sender == user %}text-end{% endif %}" data-id="{{ m.id }}"><span class="badge {% if m.sender == user %}text-bg-primary{% else %}text-bg-secondary{% endif %}">{{ m.body }}</span></div>
    {% endfor %}
  </div>
  <form method="post" action="{% url 'chat_send' other.username %}" id="chat-form" class="mt-2 d-flex gap-2">{% csrf_token %}{{ form.body }}<button class="btn btn-primary">Enviar</button></form>
</div>
<script>
const box=document.getElementById('chat-box'); box.scrollTop=box.scrollHeight;
async function poll(){
  const last=box.querySelector('[data-id]:last-child');
  const after=last?last.dataset.id:'';
  const resp=await fetch(`{% url 'chat_poll' other.username %}?after=${after}`);
  if(!resp.ok)return;
  const data=await resp.json();
  for(const m of data.messages){
    const div=document.createElement('div');div.className='mb-2 '+(m.is_me?'text-end':'');div.dataset.id=m.id;
    div.innerHTML=`<span class="badge ${m.is_me?'text-bg-primary':'text-bg-secondary'}">${m.body}</span>`;
    box.appendChild(div);
  }
  if(data.messages.length){ box.scrollTop=box.scrollHeight; }
}
setInterval(poll,2500);
</script>
{% endblock %}
